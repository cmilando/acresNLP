"storm" = "Storms",
"extreme" = "Extreme\nPrecipitation",
"heat" = "Heat",
"fire" = "Fire",
"air" = "Air Pollution",
"chemical" = "Chemical\nHazards",
"indoor" = "Indoor\nAir Pollution"
)
plot_tbl$is_hazard_fct <- ifelse(
plot_tbl$is_hazard, "a. Hazard terms",
"b. Outreach terms"
)
plot_tbl$is_ACRES_town_fct <- ifelse(
plot_tbl$is_ACRES_town, "MyRW",
"Rest of GBA Inner Core"
)
plot_tbl
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_INNER_CORE_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_INNER_CORE_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged proportion of terms') +
theme(legend.position = 'bottom')
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged proportion of terms') +
theme(legend.position = 'bottom')
ggsave("fig1_v2.png", width = 7.5, height = 5)
#
sup_tbl <- combined_tbl %>%
group_by(is_ACRES_town, most_common_town) %>%
summarize(
n = n(),
across(ends_with("_percent"), ~ mean(. , na.rm = TRUE), .names = "mean_{.col}"),
)
sup_tbl
View(sup_tbl)
MyRW_town <- read.table("MYRWA_towns.txt")
MyRW_town$V1
myrwa_town <- tolower(MyRW_town$V1)
myrw_town <- tolower(MyRW_town$V1)
#
plot_tbl <- combined_tbl %>%
mutate(is_ACRES_town = most_common_town %in% myrw_town) %>%
group_by(is_ACRES_town, most_common_town) %>%
summarize(
n = n(),
across(ends_with("_percent"), ~ mean(. , na.rm = TRUE), .names = "mean_{.col}"),
) %>%
group_by(is_ACRES_town) %>%
summarize(
n = n(),
across(starts_with("mean_"), ~ quantile(. , prob = 0.50, na.rm = TRUE), .names = "median_{.col}_x"),
across(starts_with("mean_"), ~ quantile(. , prob = 0.25, na.rm = TRUE), .names = "q25_{.col}_x"),
across(starts_with("mean_"), ~ quantile(. , prob = 0.75, na.rm = TRUE), .names = "q75_{.col}_x")
) %>%
pivot_longer(cols = ends_with("_percent_x"))
plot_tbl
##
plot_tbl$cause <- NA
plot_tbl$metric <- NA
for(i in 1:nrow(plot_tbl)) {
plot_tbl$cause[i] <- strsplit(plot_tbl$name[i], "_")[[1]][3]
plot_tbl$metric[i] <- strsplit(plot_tbl$name[i], "_")[[1]][1]
}
tail(plot_tbl)
unique(plot_tbl$cause)
unique(plot_tbl$metric)
plot_tbl <-  plot_tbl %>%
pivot_wider(id_cols = c(is_ACRES_town, n, cause),
names_from = metric,
values_from = value)
hazard_terms <- c('flood', 'storm', 'heat', 'air', 'indoor',
'chemical', 'extreme', 'fire')
#
plot_tbl$is_hazard <- NA
for(i in 1:nrow(plot_tbl)) {
plot_tbl$is_hazard[i] <- any(sapply(hazard_terms, function(x) {
grepl(x, plot_tbl$cause[i])
}))
}
x_labels <- c(
"workshop" = "Workshop",
"survey" = "Survey",
"community" = "Community\nMeeting",
"small" = "Small Group\nDiscussion",
"conversation" = "Conversation",
"inform" = "Inform",
"mapping" = "Mapping",
"flood" = "Flooding",
"storm" = "Storms",
"extreme" = "Extreme\nPrecipitation",
"heat" = "Heat",
"fire" = "Fire",
"air" = "Air Pollution",
"chemical" = "Chemical\nHazards",
"indoor" = "Indoor\nAir Pollution"
)
plot_tbl$is_hazard_fct <- ifelse(
plot_tbl$is_hazard, "a. Hazard terms",
"b. Outreach terms"
)
plot_tbl$is_ACRES_town_fct <- ifelse(
plot_tbl$is_ACRES_town, "MyRW",
"Rest of GBA Inner Core"
)
plot_tbl
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged proportion of terms') +
theme(legend.position = 'bottom')
ggsave("fig1_v2.png", width = 7.5, height = 5)
#
sup_tbl <- combined_tbl %>%
mutate(is_ACRES_town = most_common_town %in% myrw_town) %>%
group_by(is_ACRES_town, most_common_town) %>%
summarize(
n = n(),
across(ends_with("_percent"), ~ mean(. , na.rm = TRUE), .names = "mean_{.col}"),
)
View(sup_tbl)
sum(sup_tbl$n)
write.csv(sup_tbl, file = 'sup_tbl.csv', quote = F, row.names = F)
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom')
ggsave("fig1_v2.png", width = 7.5, height = 5)
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(vjust = 0))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(vjust = -1))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = -1))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0, face = 'bold'))
ggsave("fig1_v2.png", width = 7.5, height = 5)
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0, face = 'bold', size = 9))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0, face = 'bold', size = 10))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0, face = 'bold', size = 12))
#
plot_tbl %>%
ggplot(.) + theme_classic2() +
geom_point(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
y = median, color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
geom_errorbar(aes(x = reorder(cause, -median),
group = is_ACRES_town_fct,
width = 0.25,
ymin = q25, ymax = q75,
color = is_ACRES_town_fct),
position = position_dodge(width = 0.3)) +
facet_rep_wrap(~is_hazard_fct, nrow = 2, scales = 'free_x') +
scale_x_discrete(labels = x_labels) +
xlab(NULL) +
scale_color_manual(name = 'Geography',
values = c('#d95f02', '#7570b3')) +
ylab('Town-averaged percentage (%) of term usage') +
theme(legend.position = 'bottom',
strip.background = element_blank(),
strip.text = element_text(hjust = 0, face = 'bold', size = 11))
ggsave("fig1_v2.png", width = 7.5, height = 5)
plot_tbl
source("01_make_passchecks.R")
dim(combined_table)
table(combined_table$most_common_town, combined_table$pass_checks2)
table(combined_table$pass_checks2)
mancx <- read.csv(paste0(my_dir, "manual_checks_1202.csv"), header = T,
sep = "|")
head(mancx)
combined_table <- combined_table %>% left_join(mancx)
dim(combined_table)
data.frame(head(combined_table))
# ----------------------------------------------------------------------------
# get the new pdfs to 'INCLUDE'
# ----------------------------------------------------------------------------
# ma.url omitted
## NC Notes: We're reading in combined_table_v9_final.tsv" for this file, right?
##           Finally, I noticed we were dropping Malden and Waltham in the code below.
##           There are NA values in the manual checks, which I think come from duplicate reports? I think we just want to remove EXCLUDE.
##           The modified code below for the creation of pass_checks3 seems to add 4 malden and 3 Waltham reports back in...
##           Also, there are 21 GBA IC communities (I mis-counted earlier!). We'll have to update the flowchart.
#`%!in%` <- function(x, y) !(x %in% y) # NC: Added function
combined_table <- combined_table %>%
mutate(pass_checks3 = (
Manual.Check.11.19 %in% c("INCLUDE") &
duplicated == F &
(is_INNER_CORE == T | is_ACRES_town == T) &
is_MASS == T &
has_climate == 1 &
has_community == 1
))
# # malden 63
r1 <- which(combined_table$file_name == 'maldenurl63.json')
r1
combined_table$pass_checks3[r1] <- TRUE
#
# # burlington 85
# r1 <- which(combined_table$file_name == 'burlingtonurl85.json')
# r1
# combined_table$pass_checks3[r1] <- TRUE
#
# # reading 60
# r1 <- which(combined_table$file_name == 'readingurl60.json')
# r1
# combined_table$pass_checks3[r1] <- TRUE
#
# # wilmington
# r1 <- which(combined_table$file_name == 'wilmingtonurl47.json')
# r1
# combined_table$pass_checks3[r1] <- TRUE
#
# # waltham 82
r1 <- which(combined_table$file_name == 'walthamurl82.json')
length(r1)
combined_table$pass_checks3[r1] <- TRUE
# and any with url that starts with https://www.mass.gov/doc/
r1 <- which(grepl("https://www.mass.gov/doc/", combined_table$url))
length(r1)
table(combined_table$pass_checks3[r1])
combined_table$pass_checks3[r1] <- TRUE
##
### WHICH ONE IS NONE
which(combined_table$most_common_town == 'None' &
combined_table$pass_checks3)
pass_checks <- combined_table %>%
filter(pass_checks3) %>%
group_by(most_common_town) %>% tally()
sum(pass_checks$n)
# write_tsv(pass_checks, 'pass_checks_0220.tsv')
# num_irrelevant <- combined_table %>%
#   group_by(town_name) %>%
#   summarize(
#     total_pdfs = n(),
#     total_relevant = sum(relevant),
#     percent_relevant = total_relevant / n(),
#     total_towns_match = sum(towns_match),
#     percent_match = total_towns_match / n(),
#     relevant_and_match = sum(relevant & towns_match)
#     )
#
# View(num_irrelevant)
#only filter for relevant and matching
# write_tsv(combined_table, 'combined_table_v8_final.tsv')
# ----------------------------------------------------------------------------
### make flowchart
nrow(combined_table)
# 27 Original from
##
combined_table <- combined_table %>% filter(!towns_to_scrub)
nrow(combined_table)
table(combined_table$duplicated)
table(combined_table %>%
filter(duplicated == F) %>% select(is_MASS))
table(combined_table %>%
filter(duplicated == F, is_MASS == T) %>%
select(is_INNER_CORE))
table(combined_table %>%
filter(duplicated == F, is_MASS == T, is_INNER_CORE == T) %>%
select(has_climate))
table(combined_table %>%
filter(duplicated == F, is_MASS == T, is_INNER_CORE == T,
has_climate == 1) %>%
select(has_community))
table(combined_table %>%
filter(duplicated == F, is_MASS == T, is_INNER_CORE == T,
has_climate == 1, has_community == 1) %>%
select(pass_checks3))
combined_table <- combined_table %>%
mutate(pass_checks4 = duplicated == F & is_MASS == T &
is_INNER_CORE == T &
has_climate == 1 & has_community == 1 & pass_checks3)
table(combined_table$pass_checks4)
# ----------------------------------------------------------------------------
#90% or over for all towns
combined_table_relevant <- combined_table %>%
filter(pass_checks4)
nrow(combined_table_relevant)
#
# combined_table %>%
#   filter(duplicated == F, is_MASS == T, is_INNER_CORE == T,
#          has_climate == 1, has_community == 1)
dim(combined_table_relevant)
write_tsv(combined_table_relevant, 'combined_table_relevant_v10.tsv')
